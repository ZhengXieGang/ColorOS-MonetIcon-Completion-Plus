name: Icon Update Release

permissions:
  contents: write

on:
  # 手动触发开关
  workflow_dispatch:
  # 自动触发条件
  push:
    paths:
      - 'uxicons/**'       # 监听图标变动
      - 'webui/**'         # 监听 WebUI 变动
    branches:
      - main # 确保你的主分支名正确，有的是 master

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 获取完整文件结构

      - name: Calculate Icon Count & Version
        id: version
        run: |
          # 1. 调试信息：打印 uxicons 目录内容到日志，方便排查
          echo "=== Debug: Listing directory content ==="
          ls -R uxicons || echo "Warning: uxicons directory not found"
          
          # 2. 计数逻辑修正
          # 只要是 uxicons 目录下的文件都算进去，排除文件夹本身
          if [ -d "uxicons" ]; then
            count=$(find uxicons -type f | wc -l)
          else
            count=0
          fi
          
          # 去除空格
          count=$(echo $count | xargs)
          
          # 3. 智能版本号生成 logic
          # 格式: v0.{图标数}.{WebUI版本}
          
          # 获取此前的最新 Tag (v0.*)
          git fetch --tags
          LAST_TAG=$(git tag --sort=-v:refname | grep "^v0\." | head -n 1 || echo "")
          echo "Last Tag: $LAST_TAG"
          
          # 解析上一个 WebUI 版本号
          LAST_WEBUI_VER=0
          if [[ "$LAST_TAG" =~ ^v0\.([0-9]+)\.([0-9]+)$ ]]; then
             LAST_WEBUI_VER=${BASH_REMATCH[2]}
          elif [[ "$LAST_TAG" =~ ^v0\.([0-9]+)$ ]]; then
             # 兼容旧格式 v0.0058 -> 视为 v0.58.0
             LAST_WEBUI_VER=0
          fi
          
          # 检测 WebUI 变动
          NEW_WEBUI_VER=$LAST_WEBUI_VER
          if [ -n "$LAST_TAG" ]; then
             # 检查 HEAD 与 LAST_TAG 之间是否有 webui 目录的文件变动
             if git diff --name-only "$LAST_TAG" HEAD | grep -q "^webui/"; then
                NEW_WEBUI_VER=$((LAST_WEBUI_VER + 1))
                echo "WebUI 已更新 ($LAST_WEBUI_VER -> $NEW_WEBUI_VER)"
             else
                echo "WebUI 无变动，保持版本 ($LAST_WEBUI_VER)"
             fi
          fi
          
          # 图标计数 (去除前导零)
          if [ -d "uxicons" ]; then
             COUNT=$(find uxicons -type f | wc -l | xargs)
             COUNT=$(echo $COUNT | sed 's/^0*//') # 63
             [ -z "$COUNT" ] && COUNT=0
          else
             COUNT=0
          fi
          
          # 组装版本号
          VERSION="v0.${COUNT}.${NEW_WEBUI_VER}"
          
          echo "Icon Count: $COUNT"
          echo "WebUI Ver:  $NEW_WEBUI_VER"
          echo "Final Version: $VERSION"
          
          # 导出变量
          echo "ICON_COUNT=$COUNT" >> $GITHUB_OUTPUT
          echo "VERSION_TAG=$VERSION" >> $GITHUB_OUTPUT

      - name: Prepare Assets
        run: |
          # 压缩图标包
          if [ -d "uxicons" ]; then
            zip -r uxicons.zip uxicons
          else
            echo "Error: uxicons directory missing!"
            exit 1
          fi
          
          # 准备 WebUI
          if [ -d "webui" ]; then
            cd webui
            zip -r ../webui.zip .
            cd ..
          else
            echo "Error: webui directory missing!"
            exit 1
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION_TAG }}
          name: ${{ steps.version.outputs.VERSION_TAG }} # 标题只写版本号
          body: "" # 内容留空
          files: |
            uxicons.zip
            webui.zip
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
