name: Icon Update Release

permissions:
  contents: write

on:
  # 手动触发开关
  workflow_dispatch:
  # 自动触发条件
  push:
    paths:
      - 'uxicons/**'       # 监听图标变动
      - 'webui/**'         # 监听 WebUI 变动
    branches:
      - main # 确保你的主分支名正确，有的是 master

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 获取完整文件结构

      - name: Calculate Icon Count & Version
        id: version
        run: |
          # 1. 调试信息：打印 uxicons 目录内容到日志，方便排查
          echo "=== Debug: Listing directory content ==="
          ls -R uxicons || echo "Warning: uxicons directory not found"
          
          # 2. 计数逻辑修正
          # 只要是 uxicons 目录下的文件都算进去，排除文件夹本身
          if [ -d "uxicons" ]; then
            count=$(find uxicons -type f | wc -l)
          else
            count=0
          fi
          
          # 去除空格
          count=$(echo $count | xargs)
          
          # 3. 智能版本号生成 logic
          # 格式: v0.{图标数}.{WebUI版本}
          
          # 图标计数 (去除前导零)
          if [ -d "uxicons" ]; then
             COUNT=$(find uxicons -type f | wc -l | xargs)
             COUNT=$(echo $COUNT | sed 's/^0*//') # 63
             [ -z "$COUNT" ] && COUNT=0
          else
             COUNT=0
          fi
          
          # WebUI 版本: 读取 webui/webroot/index.html 中的 <!-- ReleaseCode=X -->
          # 允许手动控制 WebUI 版本号
          WEBUI_VER=$(grep -o "ReleaseCode=[0-9]\+" webui/webroot/index.html | cut -d= -f2)
          
          # 缺省值处理
          if [ -z "$WEBUI_VER" ]; then
             echo "Warning: ReleaseCode not found in index.html, defaulting to 0"
             WEBUI_VER=0
          fi
          
          # 组装版本号
          VERSION="v0.${COUNT}.${WEBUI_VER}"
          
          echo "Icon Count: $COUNT"
          echo "WebUI Ver:  $WEBUI_VER"
          echo "Final Version: $VERSION"
          
          # 导出变量
          echo "ICON_COUNT=$COUNT" >> $GITHUB_OUTPUT
          echo "VERSION_TAG=$VERSION" >> $GITHUB_OUTPUT

      - name: Prepare Assets
        run: |
          # 压缩图标包
          if [ -d "uxicons" ]; then
            zip -r uxicons.zip uxicons
          else
            echo "Error: uxicons directory missing!"
            exit 1
          fi
          
          # 准备 WebUI
          if [ -d "webui" ]; then
            cd webui
            zip -r ../webui.zip .
            cd ..
          else
            echo "Error: webui directory missing!"
            exit 1
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION_TAG }}
          name: ${{ steps.version.outputs.VERSION_TAG }} # 标题只写版本号
          body: "" # 内容留空
          files: |
            uxicons.zip
            webui.zip
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update packages.txt
        run: |
          # 列出 uxicons 下的文件夹名称，排序并去重
          if [ -d "uxicons" ]; then
            # find -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | sort | uniq > packages.txt
            # 使用 ls -1 更简单
            ls -1 -d uxicons/*/ | xargs -n 1 basename | sort | uniq > packages.txt
          else
            echo "uxicons dir missing, clearing packages.txt"
            > packages.txt
          fi
          
          # 检查是否有变动
          if git diff --quiet packages.txt; then
            echo "packages.txt is up to date"
          else
            echo "Updating packages.txt..."
            # 配置 Git
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            
            # 提交并推送
            git add packages.txt
            git commit -m "chore: auto update packages.txt list"
            git push
          fi
