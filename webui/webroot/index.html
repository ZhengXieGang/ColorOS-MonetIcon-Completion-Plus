<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å›¾æ ‡è¡¥å…¨Plus</title>
    <style>
        /* --- MD3 é£æ ¼å®šä¹‰ --- */
        :root {
            --md-sys-color-primary: #D0BCFF;
            --md-sys-color-on-primary: #381E72;
            --md-sys-color-primary-container: #4F378B;
            --md-sys-color-on-primary-container: #EADDFF;
            --md-sys-color-background: #141218;
            --md-sys-color-on-background: #E6E1E5;
            --md-sys-color-surface: #1C1B1F;
            --md-sys-color-surface-variant: #49454F;
            --md-sys-color-on-surface-variant: #CAC4D0;
            --md-sys-color-outline: #938F99;
            --md-sys-color-success: #4caf50;
            --md-sys-color-error: #ffb4ab;
        }

        body {
            margin: 0;
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            font-family: 'Roboto', sans-serif;
            padding-top: calc(env(safe-area-inset-top) + 60px);
            padding-bottom: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 92%;
            max-width: 600px;
        }

        .header {
            margin-bottom: 24px;
            padding-left: 12px;
        }

        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 400;
        }

        .header p {
            margin: 6px 0 0;
            color: var(--md-sys-color-on-surface-variant);
            font-size: 14px;
        }

        .card {
            background-color: var(--md-sys-color-surface);
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
        }

        .version-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            text-align: center;
        }

        .v-box {
            flex: 1;
        }

        .v-label {
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 4px;
        }

        .v-num {
            font-size: 24px;
            font-weight: bold;
            color: var(--md-sys-color-primary);
        }

        .v-num.local {
            color: var(--md-sys-color-on-surface);
        }

        .progress-container {
            width: 100%;
            background-color: var(--md-sys-color-surface-variant);
            border-radius: 10px;
            height: 6px;
            margin: 20px 0;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--md-sys-color-primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Unified Button Styles */
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            /* Default full width */
            padding: 16px;
            /* Larger touch area */
            border-radius: 16px;
            /* Squircle */
            border: none;
            font-size: 16px;
            font-weight: 600;
            /* Bolder */
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            margin-bottom: 12px;
            white-space: nowrap;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .btn:active {
            transform: scale(0.96);
            opacity: 0.9;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(0.5);
        }

        .btn-primary {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            /* Removed gradient and shadow for flat MD3 look */
        }

        .btn-tonal {
            background-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface-variant);
            border: none;
            /* Cleaner look */
        }

        /* Version Card V3 - Centered Stack Layout (Android Update Style) */
        .version-card {
            background-color: var(--md-sys-color-surface);
            /* Clean background */
            text-align: center;
            padding: 32px 20px;
            margin-bottom: 1px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: none;
        }

        .status-icon-large {
            font-size: 48px;
            margin-bottom: 16px;
            animation: pulse 2s infinite ease-in-out;
        }

        .status-title {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--md-sys-color-on-surface);
        }

        .version-info-line {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
            margin-top: 4px;
        }

        /* Indeterminate Progress */
        @keyframes indeterminate {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .progress-bar.indeterminate {
            width: 100% !important;
            animation: indeterminate 1.5s infinite linear;
        }

        /* Scan Progress */
        .scan-progress-wrap {
            width: 80%;
            height: 4px;
            background: var(--md-sys-color-surface-variant);
            margin: 16px auto;
            border-radius: 2px;
            overflow: hidden;
            display: none;
        }

        .scan-progress-bar {
            height: 100%;
            background: var(--md-sys-color-primary);
            width: 0%;
            transition: width 0.2s;
        }

        /* Improved Version Display */
        .version-card {
            text-align: center;
            padding: 10px;
        }

        .v-status {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 6px;
        }

        .v-detail {
            font-size: 13px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .setting-label {
            font-size: 14px;
            color: var(--md-sys-color-on-surface);
        }

        .setting-sub {
            font-size: 11px;
            color: var(--md-sys-color-outline);
            display: block;
            margin-top: 2px;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--md-sys-color-surface-variant);
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: var(--md-sys-color-outline);
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--md-sys-color-primary);
        }

        input:checked+.slider:before {
            transform: translateX(20px);
            background-color: var(--md-sys-color-on-primary);
        }

        .log-box {
            background-color: #000;
            border-radius: 12px;
            padding: 12px;
            height: 120px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #0f0;
            border: 1px solid var(--md-sys-color-surface-variant);
            white-space: pre-wrap;
            margin-top: 10px;
        }

        .info-text {
            font-size: 12px;
            color: var(--md-sys-color-outline);
            margin-top: 8px;
            text-align: center;
        }

        /* å›¾æ ‡ç®¡ç†ç•Œé¢æ ·å¼ */
        .spinner {
            border: 3px solid var(--md-sys-color-surface-variant);
            border-top: 3px solid var(--md-sys-color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .app-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .app-item:hover {
            background-color: rgba(255, 255, 255, 0.08);
            border-color: var(--md-sys-color-primary);
        }

        .app-item:active {
            transform: scale(0.98);
        }

        .app-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            margin-right: 12px;
            background-color: var(--md-sys-color-surface-variant);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
            overflow: hidden;
        }

        .app-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .app-info {
            flex: 1;
            min-width: 0;
        }

        .app-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .app-package {
            font-size: 11px;
            color: var(--md-sys-color-outline);
            font-family: 'Courier New', monospace;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* å¯¹è¯æ¡†æ ·å¼ */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .dialog {
            background-color: var(--md-sys-color-surface);
            border-radius: 28px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
        }

        .dialog-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 12px;
            color: var(--md-sys-color-on-surface);
        }

        .dialog-content {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .dialog-btn {
            padding: 10px 24px;
            border-radius: 100px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dialog-btn-cancel {
            background-color: transparent;
            color: var(--md-sys-color-primary);
        }

        .dialog-btn-confirm {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }

        .dialog-btn:active {
            opacity: 0.8;
            transform: scale(0.95);
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="header">
            <h1>å›¾æ ‡è¡¥å…¨Plus</h1>
            <p>Monet Icon Completion Manager Beta v0.1</p>
        </div>

        <div class="card">
            <!-- æ–°çš„ç‰ˆæœ¬å±•ç¤ºå¡ç‰‡ -->
            <!-- Version Card V2 -->
            <!-- Version Card V3 -->
            <div id="version-display" class="version-card">
                <div id="v-status-icon" class="status-icon-large">â˜ï¸</div>
                <div id="v-status-text" class="status-title">æ­£åœ¨æ£€æŸ¥æ›´æ–°...</div>
                <div id="v-detail-text" class="version-info-line">å½“å‰: -- | æœ€æ–°: --</div>
            </div>

            <!-- Removed standalone extra-info div as it is now inside card -->

            <div class="progress-container" id="progress-wrap">
                <div class="progress-bar" id="progress-bar"></div>
            </div>

            <button class="btn btn-primary" onclick="startUpdate()" id="update-btn" disabled>
                ç­‰å¾…æ£€æµ‹...
            </button>

            <div class="log-box" id="log-console">System Ready.</div>
        </div>

        <div class="card">
            <h3 style="margin-top:0; font-size:16px; margin-bottom:10px;">ä¸‹è½½è®¾ç½® & ç¼“å­˜</h3>

            <div class="setting-item">
                <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                    <div>
                        <span class="setting-label">ä½¿ç”¨é•œåƒç«™åŠ é€Ÿ</span>
                        <span class="setting-sub">åŠ é€Ÿä¸‹è½½åŠ API è¿æ¥ (æ¨èç½‘ç»œä¸ä½³æ—¶å¼€å¯)</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="mirror-switch" onchange="checkUpdate()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="setting-item">
                <div>
                    <span class="setting-label">ä¸´æ—¶ç¼“å­˜å ç”¨</span>
                    <span class="setting-sub">/data/adb/uxicons_cache_tmp/</span>
                </div>
                <span id="tmp-cache-size" style="color:var(--md-sys-color-primary); font-weight:bold;">è®¡ç®—ä¸­...</span>
            </div>

            <div style="margin-top:16px;">
                <button class="btn btn-tonal" onclick="clearTmpCache()">
                    æ¸…ç†ç¼“å­˜æ–‡ä»¶
                </button>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-top:0; font-size:16px; margin-bottom:10px;">è«å¥ˆå›¾æ ‡ç®¡ç†</h3>
            <p style="font-size:12px; color:var(--md-sys-color-on-surface-variant); margin-bottom:16px;">
                æ‰«ææ”¯æŒè«å¥ˆå›¾æ ‡çš„åº”ç”¨ï¼Œå¹¶ç®¡ç†è‡ªå®šä¹‰å›¾æ ‡
            </p>
            <button class="btn btn-tonal" onclick="openIconManager()">
                ç®¡ç†å›¾æ ‡
            </button>
        </div>
    </div>

    <!-- å›¾æ ‡ç®¡ç†ç•Œé¢ -->
    <div id="icon-manager-view" class="container" style="display:none;">
        <div class="header">
            <button class="btn btn-tonal" onclick="backToMain()"
                style="width:auto; padding:8px 20px; margin-bottom:12px;">
                â† è¿”å›
            </button>
            <h1>è«å¥ˆå›¾æ ‡ç®¡ç†</h1>
            <p>Monet Icon Manager</p>
            <p
                style="font-size:12px; color:var(--md-sys-color-error); margin-top:8px; background-color:rgba(255,180,171,0.1); padding:8px 12px; border-radius:8px;">
                âš ï¸ æ­¤åŠŸèƒ½ä»…é™ç³»ç»Ÿå’Œæ¨¡å—ç‰ˆæœ¬503åŠä»¥ä¸Šä½¿ç”¨!ç”¨äºè¿˜åŸåº”ç”¨è‡ªå¸¦çš„è«å¥ˆå›¾æ ‡ã€‚
            </p>
        </div>

        <div class="card">
            <div id="scan-status" style="text-align:center; padding:20px;">
                <div class="spinner"></div>
                <p style="margin-top:16px; color:var(--md-sys-color-on-surface-variant);">æ­£åœ¨æ£€æµ‹ç¯å¢ƒ...</p>
            </div>

            <div id="app-list-container" style="display:none;">
                <div style="margin-bottom:20px; text-align:center;">
                    <div
                        style="font-size:15px; color:var(--md-sys-color-on-surface); margin-bottom:12px; font-weight:500;">
                        å·²å‘ç° <span id="app-count"
                            style="color:var(--md-sys-color-primary); font-size:20px; font-weight:bold; margin:0 4px;">0</span>
                        ä¸ªæ”¯æŒåº”ç”¨
                    </div>

                    <div style="display:flex; gap:12px; justify-content:center;">
                        <button class="btn btn-tonal" onclick="openIconManager()"
                            style="width:auto; padding:10px 24px; flex:0 1 auto; margin-bottom:0;">
                            <span style="font-size:18px; line-height:1; margin-right:6px;">â†»</span> é‡æ–°æ‰«æ
                        </button>
                        <button class="btn btn-tonal" onclick="restoreAllIcons()"
                            style="width:auto; padding:10px 24px; flex:0 1 auto; margin-bottom:0; border-color:var(--md-sys-color-error); color:var(--md-sys-color-error);">
                            ğŸ—‘ï¸ ä¸€é”®æ¢å¤
                        </button>
                    </div>
                </div>

                <div id="app-list"></div>
            </div>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒé…ç½® ---
        const MOD_ROOT = "/data/adb/modules/ThemedIconCompletion";
        const WEB_ROOT = `${MOD_ROOT}/webroot`;
        const CACHE_ROOT = "/data/adb/uxicons_cache_tmp";
        const UPDATE_SCRIPT = `${MOD_ROOT}/update.sh`;
        const VERSION_FILE = `${WEB_ROOT}/version`;

        // ã€ä¿®æ­£ã€‘è¿™é‡Œçš„å˜é‡è™½ç„¶ JS å®é™…ä¸Šä¸ç›´æ¥ç”¨å®ƒæ¥ç§»åŠ¨æ–‡ä»¶äº†ï¼Œä½†ä¿æŒä¸è„šæœ¬ä¸€è‡´æ˜¯ä¸ªå¥½ä¹ æƒ¯
        const TARGET_B = `${MOD_ROOT}/my_product/media/theme/uxicons/hdpi/`;

        let currentCloudVersion = null;
        let currentLocalVersion = null;
        let downloadAssets = {}; // å­˜å‚¨ url

        // --- å·¥å…· ---

        function setIndeterminateProgress(enable) {
            const bar = document.getElementById('progress-bar');
            document.getElementById('progress-wrap').style.display = enable ? 'block' : 'none';
            if (enable) {
                bar.className = 'progress-bar indeterminate';
                bar.style.width = '100%';
            } else {
                bar.className = 'progress-bar';
                bar.style.width = '0%';
            }
        }
        function log(msg, type = 'info') {
            const consoleBox = document.getElementById('log-console');
            const time = new Date().toLocaleTimeString('en-GB');
            let color = type === 'error' ? '#ff5252' : (type === 'warn' ? '#ffeb3b' : '#0f0');
            consoleBox.innerHTML += `<div style="color:${color}">[${time}] ${msg}</div>`;
            consoleBox.scrollTop = consoleBox.scrollHeight;
        }

        async function exec(cmd) {
            if (typeof ksu === 'undefined') return { errno: 999, stderr: "Root Interface Missing" };
            try {
                let res = await ksu.exec(cmd);
                if (res === undefined && ksu.fullExec) res = await ksu.fullExec(cmd);
                if (res === undefined) return { errno: 1, stderr: "No response" };
                if (typeof res === 'string') return { errno: 0, stdout: res };
                if (res.errno === undefined) res.errno = res.stdout ? 0 : 1;
                return res;
            } catch (e) { return { errno: 998, stderr: e.message }; }
        }

        // --- ä¸šåŠ¡é€»è¾‘ ---
        async function initData() {
            await exec(`chmod +x "${UPDATE_SCRIPT}"`);

            // æœ¬åœ°ç‰ˆæœ¬
            const localRes = await exec(`cat "${VERSION_FILE}"`);
            if (localRes.errno === 0 && localRes.stdout.trim()) {
                currentLocalVersion = localRes.stdout.trim();
            } else {
                currentLocalVersion = "æœªå®‰è£…";
            }

            checkUpdate();
            refreshTmpCacheSize();
        }

        async function checkUpdate() {
            const statusText = document.getElementById('v-status-text');
            const detailText = document.getElementById('v-detail-text');
            statusText.innerText = "æ­£åœ¨æ£€æµ‹æ›´æ–°...";
            statusText.style.color = "var(--md-sys-color-on-surface)";
            detailText.innerText = `æœ¬åœ°ç‰ˆæœ¬: ${currentLocalVersion}`;

            document.getElementById('update-btn').innerText = "æ£€æµ‹ä¸­...";
            document.getElementById('update-btn').disabled = true;

            const useMirror = document.getElementById('mirror-switch').checked;
            let apiUrl = "https://api.github.com/repos/ZhengXieGang/ColorOS-MonetIcon-Completion-Plus/releases";

            if (useMirror) {
                // å°è¯•ä½¿ç”¨ kkgithub çš„ API é•œåƒ (å‡è®¾æ”¯æŒ)
                apiUrl = apiUrl.replace("api.github.com", "api.kkgithub.com");
            }

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s Timeout

                const response = await fetch(apiUrl, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const releases = await response.json();
                const latest = releases.find(r => r.tag_name.startsWith("v0."));

                if (!latest) throw new Error("æ— æœ‰æ•ˆRelease");

                currentCloudVersion = latest.tag_name;

                // æå–ä¸‹è½½é“¾æ¥
                const assetIcon = latest.assets.find(a => a.name === "uxicons.zip");
                const assetWebUI = latest.assets.find(a => a.name === "webui.zip");

                if (assetIcon) {
                    downloadAssets = {
                        icon: assetIcon.browser_download_url,
                        webui: assetWebUI ? assetWebUI.browser_download_url : null
                    };
                    updateVersionUI();
                } else {
                    throw new Error("Release ç¼ºå°‘ uxicons.zip");
                }
            } catch (e) {
                log("æ£€æµ‹å¤±è´¥: " + e.message, 'error');
                statusText.innerText = "æ£€æµ‹å¤±è´¥";
                statusText.style.color = "var(--md-sys-color-error)";
                document.getElementById('update-btn').innerText = "é‡è¯•";
                document.getElementById('update-btn').disabled = false;
                document.getElementById('update-btn').onclick = () => checkUpdate();
            }
        }

        function updateVersionUI() {
            const statusText = document.getElementById('v-status-text');
            const detailText = document.getElementById('v-detail-text');
            const iconEl = document.getElementById('v-status-icon');
            const btn = document.getElementById('update-btn');

            // å»æ‰ v å‰ç¼€æ¯”è¾ƒ
            const localClean = currentLocalVersion.replace(/^v/, '');
            const cloudClean = currentCloudVersion.replace(/^v/, '');

            if (currentLocalVersion === currentCloudVersion) {
                statusText.innerText = "å·²æ˜¯æœ€æ–°ç‰ˆ";
                statusText.style.color = "var(--md-sys-color-success)";
                detailText.innerText = `æœ¬åœ°ç‰ˆæœ¬: ${currentLocalVersion}`;
                iconEl.innerText = "âœ…";
                iconEl.style.animation = "none";

                btn.innerText = "é‡æ–°å®‰è£…";
                btn.className = "btn btn-tonal";
            } else {
                statusText.innerText = "å‘ç°æ–°ç‰ˆæœ¬";
                statusText.style.color = "var(--md-sys-color-primary)";
                detailText.innerText = `å¯æ›´æ–°è‡³ ${currentCloudVersion}`;
                iconEl.innerText = "ğŸš€";
                iconEl.style.animation = "pulse 2s infinite ease-in-out";

                btn.innerText = "ç«‹å³æ›´æ–°";
                btn.className = "btn btn-primary";
            }
            btn.disabled = false;
            btn.onclick = startUpdate;

            // ç»Ÿè®¡ä¿¡æ¯ (æ ¼å¼: v0.63.2 -> 63)
            let count = 0;
            const parts = currentCloudVersion.replace(/^v/, '').split('.');
            if (parts.length >= 2) {
                count = parseInt(parts[1], 10) || 0;
            }
            document.getElementById('extra-info').innerText = `ç´¯è®¡è¿½åŠ é€‚é… ${count} ä¸ªå›¾æ ‡`;
        }

        function updateButtonState() {
            const btn = document.getElementById('update-btn');
            btn.disabled = false;
            btn.innerText = (currentLocalVersion === currentCloudVersion) ? "å†æ¬¡æ›´æ–°" : "ç«‹å³æ›´æ–°";
            btn.className = (currentLocalVersion === currentCloudVersion) ? "btn btn-tonal" : "btn btn-primary";
        }

        async function startUpdate() {
            if (!downloadAssets.icon) return;
            const btn = document.getElementById('update-btn');
            const useMirror = document.getElementById('mirror-switch').checked;

            btn.disabled = true;
            btn.innerText = "ä¸‹è½½ä¸­...";

            const transUrl = (url) => {
                if (useMirror && url.includes("github.com")) {
                    return url.replace("github.com", "kkgithub.com");
                }
                return url;
            };

            try {
                setIndeterminateProgress(true);
                log("=== æ­¥éª¤ 1: å‡†å¤‡ç¯å¢ƒ ===");

                await exec(`rm -rf "${CACHE_ROOT}"`);
                await exec(`mkdir -p "${CACHE_ROOT}"`);

                log("=== æ­¥éª¤ 2: ä¸‹è½½æ–‡ä»¶ ===");

                // 1. Download Icon Pack
                log("æ­£åœ¨ä¸‹è½½å›¾æ ‡åŒ…...");
                const iconUrl = transUrl(downloadAssets.icon);
                await downloadFile(iconUrl, `${CACHE_ROOT}/uxicons.zip`);

                // 2. Download WebUI (if available)
                if (downloadAssets.webui) {
                    log("æ­£åœ¨ä¸‹è½½ WebUI æ›´æ–°åŒ…...");
                    const webuiUrl = transUrl(downloadAssets.webui);
                    try {
                        await downloadFile(webuiUrl, `${CACHE_ROOT}/webui.zip`);
                    } catch (e) {
                        log("WebUI ä¸‹è½½å¤±è´¥ (éè‡´å‘½): " + e.message, 'warn');
                    }
                }

                refreshTmpCacheSize();

                log("=== æ­¥éª¤ 3: è°ƒç”¨å®‰è£…è„šæœ¬ ===");
                btn.innerText = "æ­£åœ¨å®‰è£…...";

                const scriptCmd = `sh "${UPDATE_SCRIPT}" "${currentCloudVersion}"`;
                const scriptRes = await exec(scriptCmd);

                log(scriptRes.stdout);

                if (scriptRes.errno !== 0 && !scriptRes.stdout.includes("Success")) {
                    throw new Error("å®‰è£…è„šæœ¬æŠ¥é”™ï¼Œè¯·çœ‹ä¸Šæ–¹æ—¥å¿—");
                }

                setIndeterminateProgress(false);
                currentLocalVersion = currentCloudVersion;

                // Update Local Version Display
                const detailText = document.getElementById('v-detail-text');
                if (detailText) detailText.innerText = `å½“å‰ç‰ˆæœ¬: ${currentLocalVersion}`;
                updateVersionUI();

                refreshTmpCacheSize();

                log("=== å…¨éƒ¨å®Œæˆ ===", 'success');
                btn.innerText = "æ›´æ–°æˆåŠŸ";
                btn.style.backgroundColor = "var(--md-sys-color-success)";

                // Reload page after update if webui was updated? 
                // Or just reset button.
                setTimeout(() => {
                    btn.disabled = false;
                    updateVersionUI();
                }, 3000);

            } catch (e) {
                log(e.message, 'error');
                btn.innerText = "é‡è¯•";
                btn.style.backgroundColor = "var(--md-sys-color-error)";
                btn.disabled = false;
                setIndeterminateProgress(false);
                refreshTmpCacheSize();
            }
        }

        async function downloadFile(url, dest) {
            const curlCmd = `curl -L -k -4 --connect-timeout 20 --retry 2 -H "User-Agent: Mozilla/5.0" -o "${dest}" "${url}"`;
            const dlRes = await exec(curlCmd);
            const sizeCheck = await exec(`wc -c < "${dest}"`);
            const fileSize = parseInt(sizeCheck.stdout.trim()) || 0;

            if (fileSize < 1000) {
                throw new Error(`ä¸‹è½½å¼‚å¸¸ (å¤§å° ${fileSize}B)`);
            }
            log(`ä¸‹è½½æˆåŠŸ: ${dest.split('/').pop()} (${Math.round(fileSize / 1024)}KB)`);
        }

        async function refreshTmpCacheSize() {
            const res = await exec(`du -sh "${CACHE_ROOT}" 2>/dev/null | cut -f1`);
            let size = (res.stdout || "").trim();
            // å¿½ç•¥ Linux ç©ºç›®å½•å ç”¨ (4.0K)
            if (size === "4.0K" || size === "3.5K" || !size) {
                size = "0B";
            }
            document.getElementById('tmp-cache-size').innerText = size;
        }

        async function clearTmpCache() {
            await exec(`rm -rf "${CACHE_ROOT}"`);
            await refreshTmpCacheSize();
            log("ä¸´æ—¶ç¼“å­˜å·²æ¸…ç†ã€‚", 'success');
            if (typeof ksu !== 'undefined' && ksu.toast) ksu.toast("ç¼“å­˜æ¸…ç†å®Œæˆ");
        }

        // === å›¾æ ‡ç®¡ç†åŠŸèƒ½ ===
        const SCAN_SCRIPT = `${MOD_ROOT}/scan_monet.sh`;
        const CLEAN_SCRIPT = `${MOD_ROOT}/clean_icon.sh`;
        const MONET_APPS_FILE = `${CACHE_ROOT}/moneticon_apps`;
        const DELETE_LIST_FILE = `${CACHE_ROOT}/delete_packages.txt`;
        const MODULE_PROP = `${MOD_ROOT}/module.prop`;
        const TARGET_PATH1 = `${MOD_ROOT}/my_product/media/theme/uxicons/hdpi/`;
        const TARGET_PATH2 = `${MOD_ROOT}/data/oplus/uxicons/`;

        let monetApps = [];

        const SCAN_LOG = `${CACHE_ROOT}/scan.log`;
        let scanTimer = null;
        let isScanning = false;

        async function openIconManager() {
            // åˆ‡æ¢åˆ°å›¾æ ‡ç®¡ç†è§†å›¾
            document.querySelector('.container').style.display = 'none';
            document.getElementById('icon-manager-view').style.display = 'block';

            // é‡ç½® UI
            const statusEl = document.getElementById('scan-status');
            statusEl.style.display = 'block';
            statusEl.innerHTML = `
                <div class="spinner"></div>
                <p id="scan-msg" style="margin-top:16px; color:var(--md-sys-color-on-surface-variant);">æ­£åœ¨å‡†å¤‡æ‰«æ...</p>
                <!-- è¿›åº¦æ¡ -->
                <div id="scan-progress-wrap" class="scan-progress-wrap">
                    <div id="scan-progress-bar" class="scan-progress-bar"></div>
                </div>
                <div id="scan-file" style="font-size:12px; color:var(--md-sys-color-outline); margin-top:8px; height:20px;"></div>

            `;
            document.getElementById('app-list-container').style.display = 'none';

            // å¼€å§‹åå°æ‰«æ
            try {
                // èµ‹äºˆæƒé™å¹¶åˆ›å»ºç›®å½•
                await exec(`chmod +x "${SCAN_SCRIPT}"`);
                await exec(`mkdir -p "${CACHE_ROOT}"`);

                // æ¸…ç†æ—§æ—¥å¿—å’Œç»“æœæ–‡ä»¶
                await exec(`rm -f "${MONET_APPS_FILE}"`);
                await exec(`echo "å‡†å¤‡å°±ç»ª" > "${SCAN_LOG}"`);

                // å¯åŠ¨åå°è¿›ç¨‹ (nohup ... &)
                // æ³¨æ„ï¼šWebUI ç¯å¢ƒä¸‹ nohup å¯èƒ½éœ€è¦å®Œæ•´è·¯å¾„æˆ–ç‰¹æ®Šå¤„ç†ï¼Œè¿™é‡Œå°è¯•ç›´æ¥åå°è¿è¡Œ
                const scanCmd = `nohup sh "${SCAN_SCRIPT}" > /dev/null 2>&1 &`;
                await exec(scanCmd);

                isScanning = true;
                pollScanProgress();

            } catch (e) {
                statusEl.innerHTML = `
                    <p style="color:var(--md-sys-color-error); text-align:center;">å¯åŠ¨å¤±è´¥: ${e.message}</p>
                    <button class="btn btn-tonal" onclick="backToMain()" style="margin-top:16px;">è¿”å›</button>
                `;
            }
        }

        function pollScanProgress() {
            if (scanTimer) clearInterval(scanTimer);

            scanTimer = setInterval(async () => {
                if (!isScanning) {
                    clearInterval(scanTimer);
                    return;
                }

                try {
                    // è¯»å–æ—¥å¿—æœ€åå‡ è¡Œ
                    const logRes = await exec(`tail -n 1 "${SCAN_LOG}"`);
                    if (logRes.errno === 0) {
                        const line = logRes.stdout.trim();

                        // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                        if (line === "DONE" || line.includes("æ‰«æå®Œæˆ")) {
                            clearInterval(scanTimer);
                            isScanning = false;

                            // Reset Progress Bar
                            document.getElementById('scan-progress-wrap').style.display = 'none';

                            await loadScanResults();
                            return;
                        }

                        // æ–°çš„è¿›åº¦æ ¼å¼: PROGRESS:12/100:com.pkg
                        if (line.startsWith("PROGRESS:")) {
                            const parts = line.split(':'); // ["PROGRESS", "12/100", "pkg"]
                            if (parts.length >= 3) {
                                const ratio = parts[1]; // 12/100
                                const pkg = parts[2];
                                const [curr, total] = ratio.split('/').map(Number);

                                // Update Progress Bar
                                if (total > 0) {
                                    const percent = (curr / total) * 100;
                                    document.getElementById('scan-progress-bar').style.width = percent + '%';
                                    document.getElementById('scan-progress-wrap').style.display = 'block';
                                }

                                const fileEl = document.getElementById('scan-file');
                                if (fileEl) fileEl.innerText = `${pkg} (${curr}/${total})`;
                            }
                        } else if (line) {
                            const fileEl = document.getElementById('scan-file');
                            if (fileEl) fileEl.innerText = line.replace("æ­£åœ¨æ‰«æ: ", "");
                        }
                    }
                } catch (e) {
                    console.log("è½®è¯¢å‡ºé”™:", e);
                }
            }, 500); // æ¯500msè½®è¯¢ä¸€æ¬¡
        }

        async function stopScan() {
            isScanning = false;
            if (scanTimer) clearInterval(scanTimer);

            // å°è¯•ç»ˆæ­¢è¿›ç¨‹ (ç®€å•åŒ¹é…è„šæœ¬å)
            await exec(`pkill -f "scan_monet.sh"`);

            document.getElementById('scan-status').innerHTML = `
                <p style="color:var(--md-sys-color-error); margin-bottom:16px;">æ‰«æå·²æ‰‹åŠ¨ç»ˆæ­¢</p>
                <button class="btn btn-tonal" onclick="openIconManager()">é‡æ–°æ‰«æ</button>
                <button class="btn btn-tonal" onclick="backToMain()" style="margin-left:8px;">è¿”å›</button>
            `;
        }

        // æ›¿ä»£åŸæ¥çš„ displayAppListï¼Œæ”¹åä¸º loadScanResults å¹¶è°ƒç”¨ displayAppList
        async function loadScanResults() {
            // è¯»å–æ‰«æç»“æœï¼ŒæŠŠæ¢è¡Œè½¬ä¸ºé€—å·
            const appsRes = await exec(`cat "${MONET_APPS_FILE}" | tr '\\n' ','`);

            // å³ä½¿æ²¡æœ‰ç»“æœï¼Œå¦‚æœæ–‡ä»¶å­˜åœ¨ä¹Ÿä½œä¸ºç»“æœå¤„ç†ï¼ˆå¯èƒ½æ˜¯çœŸçš„æ²¡æœ‰æ”¯æŒçš„åº”ç”¨ï¼‰
            if (appsRes.errno !== 0) {
                document.getElementById('scan-status').innerHTML = `
                    <p>è¯»å–ç»“æœå¤±è´¥</p>
                    <button class="btn btn-tonal" onclick="openIconManager()">é‡è¯•</button>
                `;
                return;
            }

            // è§£æé€»è¾‘ï¼šç”¨é€—å·åˆ†å‰²
            monetApps = appsRes.stdout.split(',').map(line => line.trim()).filter(line => line.length > 0);

            displayAppList();
        }

        async function displayAppList() {
            document.getElementById('scan-status').style.display = 'none';
            document.getElementById('app-list-container').style.display = 'block';
            document.getElementById('app-count').innerText = monetApps.length;

            const appListDiv = document.getElementById('app-list');
            appListDiv.innerHTML = '';

            if (monetApps.length === 0) {
                appListDiv.innerHTML = `
                    <div style="text-align:center; padding:40px 0; color:var(--md-sys-color-outline);">
                        æœªæ‰¾åˆ°æ”¯æŒçš„åº”ç”¨
                    </div>
                 `;
                return;
            }

            // å…ˆå¿«é€Ÿæ˜¾ç¤ºæ‰€æœ‰å¡ç‰‡ï¼ˆä»…æ˜¾ç¤ºåŒ…åï¼Œæ— å›¾æ ‡ï¼‰
            monetApps.forEach(pkg => {
                const appItem = document.createElement('div');
                appItem.className = 'app-item';
                appItem.id = `item-${pkg.replace(/\./g, '_')}`;
                appItem.onclick = () => restoreSingleIcon(pkg, pkg);

                appItem.innerHTML = `
                    <div class="app-info">
                        <div class="app-name" id="name-${pkg.replace(/\./g, '_')}" style="font-size:16px;">åŠ è½½ä¸­...</div>
                        <div class="app-package" style="margin-top:2px;">${pkg}</div>
                    </div>
                `;
                appListDiv.appendChild(appItem);
            });

            // åå°å¼‚æ­¥è·å–åº”ç”¨åç§°
            updateAppLabels();
        }

        async function updateAppLabels() {
            for (const pkg of monetApps) {
                let appName = pkg;
                try {
                    // 1. å°è¯• $packageManager
                    if (typeof $packageManager !== 'undefined') {
                        const appInfo = $packageManager.getApplicationInfo(pkg, 0, 0);
                        if (appInfo) appName = appInfo.getLabel().toString();
                    }
                    // 2. å°è¯• KSU API
                    else if (typeof ksu !== 'undefined' && ksu.getPackagesInfo) {
                        const info = await ksu.getPackagesInfo(pkg);
                        if (info && info.appLabel) appName = info.appLabel;
                    }
                } catch (e) { }

                // Update DOM
                const safeId = pkg.replace(/\./g, '_');
                const nameEl = document.getElementById(`name-${safeId}`);
                const itemEl = document.getElementById(`item-${safeId}`);
                if (nameEl) nameEl.innerText = appName;
                if (itemEl) itemEl.onclick = () => restoreSingleIcon(pkg, appName);

                continue;
                // Original logic skipped

                try {
                    // è·å–åº”ç”¨åç§°ï¼ˆä½¿ç”¨ dumpsysï¼‰
                    const labelCmd = `dumpsys package ${pkg} | grep -m 1 "labelRes" -A 5 | grep "applicationLabel" | head -n 1`;
                    const labelRes = await exec(labelCmd);

                    let appName = pkg;
                    if (labelRes.stdout && labelRes.stdout.trim()) {
                        const nameMatch = labelRes.stdout.match(/applicationLabel=([^\n]+)/);
                        if (nameMatch && nameMatch[1]) {
                            appName = nameMatch[1].trim();
                        }
                    }

                    // æ›´æ–° DOM
                    const safeId = pkg.replace(/\./g, '_');
                    const nameEl = document.getElementById(`name-${safeId}`);
                    const itemEl = document.getElementById(`item-${safeId}`);

                    if (nameEl) nameEl.innerText = appName;
                    if (itemEl) itemEl.onclick = () => restoreSingleIcon(pkg, appName);
                } catch (e) {
                    console.log(`è·å–åç§°å¤±è´¥ ${pkg}:`, e);
                    const safeId = pkg.replace(/\./g, '_');
                    const nameEl = document.getElementById(`name-${safeId}`);
                    if (nameEl && nameEl.innerText === "åŠ è½½ä¸­...") {
                        nameEl.innerText = pkg;
                    }
                }
            }
        }



        async function backToMain() {
            // åœæ­¢æ‰«æè®¡æ—¶å™¨
            isScanning = false;
            if (scanTimer) clearInterval(scanTimer);

            // ç»ˆæ­¢å¯èƒ½å­˜åœ¨çš„æ‰«æè¿›ç¨‹
            await exec(`pkill -f "scan_monet.sh"`);

            // åˆ é™¤ç»“æœæ–‡ä»¶ï¼ˆå“åº”ç”¨æˆ·éœ€æ±‚ï¼šå¦‚æœç”¨æˆ·ç‚¹äº†è¿”å›...åˆ é™¤moneticon_appsæ–‡ä»¶ï¼‰
            await exec(`rm -f "${MONET_APPS_FILE}"`);

            document.getElementById('icon-manager-view').style.display = 'none';
            document.querySelector('.container').style.display = 'block';
        }

        async function restoreSingleIcon(pkg, appName) {
            showDialog(
                "æ¢å¤è«å¥ˆå›¾æ ‡",
                `æ˜¯å¦æ¢å¤è¯¥åº”ç”¨è‡ªå¸¦çš„è«å¥ˆå›¾æ ‡?<br><br><strong>${appName}</strong><br><span style="font-size:11px; color:var(--md-sys-color-outline);">${pkg}</span>`,
                true,
                async () => {
                    try {
                        // å†™å…¥è¦åˆ é™¤çš„åŒ…ååˆ°ä¸´æ—¶æ–‡ä»¶
                        await exec(`echo "${pkg}" > "${DELETE_LIST_FILE}"`);

                        // èµ‹äºˆæ¸…ç†è„šæœ¬æ‰§è¡Œæƒé™
                        await exec(`chmod +x "${CLEAN_SCRIPT}"`);

                        // æ‰§è¡Œæ¸…ç†è„šæœ¬
                        const cleanRes = await exec(`sh "${CLEAN_SCRIPT}"`);

                        if (typeof ksu !== 'undefined' && ksu.toast) {
                            ksu.toast("æ¢å¤æˆåŠŸ: " + appName);
                        }

                        // ä»åˆ—è¡¨ä¸­ç§»é™¤
                        monetApps = monetApps.filter(p => p !== pkg);
                        await displayAppList();

                    } catch (e) {
                        if (typeof ksu !== 'undefined' && ksu.toast) {
                            ksu.toast("æ¢å¤å¤±è´¥: " + e.message);
                        }
                    }
                }
            );
        }

        async function restoreAllIcons() {
            if (monetApps.length === 0) {
                if (typeof ksu !== 'undefined' && ksu.toast) ksu.toast("æ²¡æœ‰å¯æ¢å¤çš„åº”ç”¨");
                return;
            }

            showDialog(
                "ä¸€é”®æ¢å¤",
                `ç¡®å®šè¦æ¢å¤æ‰€æœ‰ ${monetApps.length} ä¸ªåº”ç”¨çš„è«å¥ˆå›¾æ ‡å—ï¼Ÿ<br><br>æ­¤æ“ä½œå°†åˆ é™¤è¿™äº›åº”ç”¨çš„è‡ªå®šä¹‰å›¾æ ‡è¦†ç›–ã€‚`,
                true,
                async () => {
                    try {
                        // å†™å…¥æ‰€æœ‰åŒ…ååˆ°åˆ é™¤åˆ—è¡¨
                        const allPkgs = monetApps.join('\n');
                        await exec(`echo "${allPkgs}" > "${DELETE_LIST_FILE}"`);

                        // èµ‹äºˆæ¸…ç†è„šæœ¬æ‰§è¡Œæƒé™
                        await exec(`chmod +x "${CLEAN_SCRIPT}"`);

                        // æ‰§è¡Œæ¸…ç†è„šæœ¬
                        const cleanRes = await exec(`sh "${CLEAN_SCRIPT}"`);

                        if (typeof ksu !== 'undefined' && ksu.toast) {
                            ksu.toast(`å·²æ¢å¤ ${monetApps.length} ä¸ªåº”ç”¨çš„å›¾æ ‡`);
                        }

                        // æ¸…ç©ºåˆ—è¡¨
                        monetApps = [];
                        await displayAppList();

                    } catch (e) {
                        if (typeof ksu !== 'undefined' && ksu.toast) {
                            ksu.toast("æ‰¹é‡æ¢å¤å¤±è´¥: " + e.message);
                        }
                    }
                }
            );
        }

        function showDialog(title, content, showCancel, onConfirm) {
            const overlay = document.createElement('div');
            overlay.className = 'dialog-overlay';

            const cancelBtn = showCancel ? `
                <button class="dialog-btn dialog-btn-cancel" onclick="this.closest('.dialog-overlay').remove()">
                    å–æ¶ˆ
                </button>
            ` : '';

            overlay.innerHTML = `
                <div class="dialog">
                    <div class="dialog-title">${title}</div>
                    <div class="dialog-content">${content}</div>
                    <div class="dialog-buttons">
                        ${cancelBtn}
                        <button class="dialog-btn dialog-btn-confirm" id="dialog-confirm">
                            ç¡®å®š
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);

            document.getElementById('dialog-confirm').onclick = () => {
                overlay.remove();
                if (onConfirm) onConfirm();
            };

            // ç‚¹å‡»é®ç½©å±‚å…³é—­
            overlay.onclick = (e) => {
                if (e.target === overlay) overlay.remove();
            };
        }

        window.onload = initData;
    </script>
</body>

</html>